\ifthesis@marginpar
\thesis@info{Enable marginpar support}
\RequirePackage{mparhack}
\thesis@info{Providing \string\sidenote\space macro for \string\marginpar.}

\RequirePackage{ragged2e}

% \itshape
\def\thesis@marginpar@font{\scriptsize\color{black}}
\ifthesis@draft
\PassOptionsToPackage{fulladjust,parboxrestore}{marginnote}
\RequirePackage{marginnote}
\let\marginfont\thesis@marginpar@font
\else
\RequirePackage[draft=false,autoclearnotecolumns]{scrlayer-notecolumn}
\setkomafont{notecolumn.marginpar}{\thesis@marginpar@font}
\fi

\RequirePackage{ifoddpage}
\newcommand*\sidenote{\@ifstar\@sidenote\@@sidenote}
\newif\ifinsidenote
\ifthesis@oneside
\def\thesis@ragged@do#1#2{#1}
\else
\def\thesis@ragged@do#1#2{\checkoddpage\ifoddpage#1\else#2\fi}
\fi
\let\thesisifodd\thesis@ragged@do
\def\thesis@ragged{\thesis@ragged@do{\RaggedRight}{\RaggedLeft}}% \captionsetup{justification=RaggedLeft}
\def\thesisinverseragged{\thesis@ragged@do{\RaggedLeft}{\RaggedRight}}
\def\thesissidebarhook{\urlstyle{rm}}
\long\def\thesis@sn@gd#1#2{\raisebox{#1}{\thesis@sn@gd@{#2}}}
\long\def\thesis@sn@gd@#1{\parbox\linewidth{\insidenotetrue\thesis@ragged\thesissidebarhook#1\vskip2.25pt}}
\def\@sidenote{\@ifnextchar[{\s@sidenote}{\s@sidenote[\z@]}}
\def\@@sidenote{\@ifnextchar[{\s@@sidenote}{\s@@sidenote[\z@]}}

% We want nested sidenotes to appear exactly where they should be and not in a second or third run. Currently i will not do this recursively but just for one level at a time.
% TODO: configure fonts
\ifthesis@draft
\long\def\s@sidenote[#1]#2{\marginnote{\normalfont\scriptsize\itshape\thesis@sn@gd{#1}{#2}}}
\long\def\s@@sidenote[#1]#2{\marginnote{\normalfont\scriptsize\itshape\thesis@sn@gd{#1}{#2}}}
\else
\long\def\s@sidenote[#1]#2{\ifx#1\z@ \makenote*{\thesis@sn@gd@{#2}}\else\makenote*{\thesis@sn@gd{#1}{#2}}\fi}
\long\def\s@@sidenote[#1]#2{\ifx#1\z@ \makenote{\protect\thesis@sn@gd@{#2}}\else\makenote{\protect\thesis@sn@gd{#1}{#2}}\fi}
\fi

% % TODO: make configurable
% \long\def\thesis@marginpar@content@#1{\raisebox{\dimexpr-4.75pt}{\parbox\linewidth{\scriptsize\itshape#1\vskip2.25pt}}}

% \let\thesis@oldmarginpar\marginpar
% \renewcommand{\marginpar}[2][]{%
%    \thesis@oldmarginpar[\thesis@marginpar@content@{\RaggedLeft#1#2}]{\thesis@marginpar@content@{\RaggedRight#1#2}}%
% }
\else
\thesis@info{Disable marginpar support, still supplying sidenote foots}
\long\def\s@sidenote[#1]#2{\footnote{#2}}
\long\def\s@@sidenote[#1]#2{\footnote{#2}}
\fi